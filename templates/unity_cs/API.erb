/* generated by rpcoder */
using UnityEngine;
using LitJson;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Text;
using Aiming.IteratorTasks;

namespace <%= get_namespace %>
{
	public class <%= contract_name %> : <%= contract_name %>Interface
	{
		public const string RESTART		= "RESTART";
		public const string RETENTION	= "RETENTION";
		public const string TRANSITION	= "TRANSITION";
		public const string RELOAD		= "RELOAD";

        <%- constants.each do |constant| -%>
        public const int <%= constant.name %> = <%= constant.value %>;
        <%- end -%>

		public string BaseUrl { get; set; }
		public RpcLogger Logger { get; set; } 
		private void Log(string log)
		{
			if(Logger != null) Logger(log);
		}

		public event Action<JsonData> Responded;
		private void RaiseResponded(JsonData jsonData)
		{
			var d = Responded;
			if (d != null) d(jsonData);
		}

		public Func<string, string> CustomValidator;
		private string Validate(string source)
		{
			var d = CustomValidator;
			if(d != null)
			{
				return CustomValidator(source);
			}
			else
			{
				return source;
			}
		}

		private Dictionary<string, string> commonParameterList = new Dictionary<string, string>();

		public void AddCommonParameter(string key, string value)
		{
			commonParameterList[key] = value;
		}

		public string RemoveCommonParameter(string key)
		{
			string returnValue = "";
			if (commonParameterList.ContainsKey(key))
			{
				returnValue = commonParameterList[key];
				commonParameterList.Remove(key);
			}
			return returnValue;
		}

		public string DefaultErrorMessage { get; set; }
		public RpcErrorHandler ErrorHandler { get; set; }
		
		public <%= contract_name %>(string baseUrl)
		{
			BaseUrl = baseUrl;
			DefaultErrorMessage = "";
			JsonMapper.RegisterImporter<int, double?>((i) => (double?)i);
			JsonMapper.RegisterImporter<int, double>((i) => (double)i);
			JsonMapper.RegisterImporter<int, int?>((i) => (int?)i);
		}

		private string AddQueryDelimiter(string source)
		{
			if(source == "")
			{
				source += "?";
			}
			else
			{
				source += "&";
			}
			return source;
		}

		<%- rpcs.each do |func| -%>
		<%-
			response = func.name.camelize + "Response"
			successHandler = "Action<" + response + ">"
			params_excluded_error_handler = func.params.map{|i| [i.array_or_type, i.name.to_s.camelize(false)].join(' ') } + [successHandler + ' success']
			params = params_excluded_error_handler + ['RpcErrorHandler error']
		-%>
		/// <summary>
		/// <%= func.get_description %>
		/// </summary>
		<%- func.params.each do |param| -%>
		/// <param name="<%= param.name.to_s.camelize(false) %>"><%= param.options[:description] %></param>
		<%- end -%>
		public IEnumerator <%= func.name.camelize %>(<%= params_excluded_error_handler.join(', ') %>)
		{
			return this.<%= func.name.camelize %>(<%= (func.params.map{|i| i.name.to_s.camelize(false) } + ['success']).join(', ') %>, null, null, null);
		}

		/// <summary>
		/// <%= func.get_description %>
		/// </summary>
		<%- func.params.each do |param| -%>
		/// <param name="<%= param.name.to_s.camelize(false) %>"><%= param.options[:description] %></param>
		<%- end -%>
		public IEnumerator <%= func.name.camelize %>(<%= params.join(', ') %>, Action throwIfCancelRequested, Action<float> reportProgress)
		{
			string path = <%= func.path_parts.join(' + ') %>;
			<%- if func.is_get? -%>
			var args = new Dictionary<string, System.Object>();
			<%- else -%>
			var args = new JsonData();
			<%- end -%>

            <%- if func.has_query_params? -%>
			<%- func.query_params.each do |i| -%>
			<%- if i.optional? -%>
			if (<%= i.name.to_s.camelize(false) %> != null)
			<%- end -%>
			{
				<%- if i.array? -%>
				args["<%= i.name.to_s %>"] = ToJson(<%= i.name.to_s.camelize(false) %>);
				<%- else -%>
				args["<%= i.name.to_s %>"] = <%= i.name.to_s.camelize(false) %>;
				<%- end -%>
			}
			<%- end -%>
			<%- end -%>

			string text = null;
			string errorText = null;

			<%- if func.is_get? -%>
			var w = GetTextFromWww(this.BaseUrl + path, args, throwIfCancelRequested, reportProgress,
				x => text = x,
				x => errorText = x);
			<%- else -%>
			var w = PostTextFromWww(this.BaseUrl + path, args, throwIfCancelRequested, reportProgress,
				x => text = x,
				x => errorText = x);
			<%- end -%>

			foreach (var x in w) yield return x;

			if (error == null)
			{
				error = ErrorHandler;
			}

			if (errorText != null)
			{
				<%- if func.is_get? -%>
					error(RETENTION, DefaultErrorMessage + (Debug.isDebugBuild ? "\n" + this.BaseUrl + path + "\n" + errorText : ""), null);
				<%- else -%>
					error(RETENTION, DefaultErrorMessage + (Debug.isDebugBuild ? "\n" + this.BaseUrl + path + " " + args.ToJson() + "\n" + errorText : ""), null);
				<%- end -%>
			}
			else
			{
				<%-
					args = []
					if func.has_responses?
						args = func.responses.map {|param|
							if param.array?
								if param.original_type?
									param.name.to_s.camelize + " = jsonData.ContainsKey(\"#{param.name}\") ? JsonMapper.ToObject<#{param.array_or_type}>(jsonData[\"#{param.name}\"].ToJson()) : null"
								else
									param.name.to_s.camelize + " = #{param.type}.CreateList(jsonData.GetValueOrDefault(\"#{param.name}\"))"
								end
							else
								if param.original_type?
									param.name.to_s.camelize + " = (#{param.array_or_type})jsonData.GetValueOrDefault(\"#{param.name}\")"
								else
									param.name.to_s.camelize + " = #{param.type}.Create(jsonData.GetValueOrDefault(\"#{param.name}\"))"
								end
							end
						}
					end
				-%>
				ParseResponse("<%= func.name.camelize %>", text,
					jsonData => new <%= response %>(){<%= args.join(",\n\t\t\t\t\t\t\t") %>},
					success,
					error);
			}
		}
		
		<%- end -%>

		private static JsonData ToJson<T>(List<T> list)
		{
			JsonData arrayData = new JsonData();
			var count = list.Count;
			if (count > 0)
			{
				for (int i = 0; i < count; ++i)
				{
					arrayData.Add(list[i]);
				}
			}
			else
			{
				arrayData.Add(0);
				arrayData.Clear();
			}
			return arrayData;
		}

		private void ParseResponse<T>(string methodName, string jsonText, Func<JsonData, T> parser, Action<T> success, RpcErrorHandler error)
		{
			Log(methodName + " responded " + jsonText);
			try
			{
				var text = Validate(jsonText);
				JsonData jsonData = JsonMapper.ToObject(text);
				<%= contract_name %>.HandleDebugMessage(jsonData, Log);

				var hasError = <%= contract_name %>.HandleError(jsonData, error);

				if (!hasError)
				{
					success(parser(jsonData));
					RaiseResponded(jsonData);
				}
			}
			catch (JsonException)
			{
				error(RESTART, "Json parse Error\n" + jsonText, null);
			}
		}

		private IEnumerable GetTextFromWww(string url, IDictionary<string, object> data, Action throwIfCancelRequested, Action<float> reportProgress, Action<string> success, Action<string> error)
		{
			foreach (string key in commonParameterList.Keys)
			{
				data[key] = commonParameterList[key];
			}

			string argsPath = string.Empty;
			foreach (var item in commonParameterList)
			{
				argsPath = AddQueryDelimiter(argsPath);
				argsPath += WWW.EscapeURL(item.Key) + "=" + WWW.EscapeURL(item.Value.ToString());

			}

			string fullPath = url + argsPath;
			Log("request " + fullPath);

			using (var www = new WWW(fullPath))
			{
				bool canceled = false;
				while (!www.isDone && !canceled)
				{
					if (throwIfCancelRequested != null) throwIfCancelRequested();
					if (reportProgress != null) reportProgress(www.progress);
					yield return null;
				}

				if (www.error != null)
				{
					error(www.error);
				}
				else
				{
					success(www.text);
				}
			}
		}

		private IEnumerable PostTextFromWww(string url, JsonData data, Action throwIfCancelRequested, Action<float> reportProgress, Action<string> success, Action<string> error)
		{
			foreach (string key in commonParameterList.Keys)
			{
				data[key] = commonParameterList[key];
			}

			var json = data.ToJson();
			byte[] byteArray = Encoding.UTF8.GetBytes(json == String.Empty ? " " : json);
			Log("request " + url + " " + json);

			using (var www = new WWW(url, byteArray))
			{
				bool canceled = false;
				while (!www.isDone && !canceled)
				{
					if (throwIfCancelRequested != null) throwIfCancelRequested();
					if (reportProgress != null) reportProgress(www.progress);
					yield return null;
				}

				if (www.error != null)
				{
					error(www.error);
				}
				else
				{
					success(www.text);
				}
			}
		}

		public static bool HandleError(JsonData jsonData, RpcErrorHandler error)
		{
			JsonData errorJsonData;

			if (!jsonData.TryGetValue("rpcError", out errorJsonData))
				return false;

			JsonData errorTypeJson;
			
			if(!errorJsonData.TryGetValue("errorType", out errorTypeJson))
				return false;

			string errorType = (string)errorTypeJson;

			string message = "";
			JsonData messageJson;
			if (errorJsonData.TryGetValue("message", out messageJson))
			{
				message = (string)messageJson;
			}
			JsonData targetSceneJson;
			string targetScene = null;
			if (errorJsonData.TryGetValue("targetScene", out targetSceneJson))
			{
				targetScene = (string)targetSceneJson;
			}
			error(errorType, message, targetScene);
			return true;
		}

		public static void HandleDebugMessage(JsonData jsonData, Action<string> logger)
		{
			JsonData message;
			if(jsonData.TryGetValue("debugMessage", out message))
			{
				logger((string)message);
			}
		}
	}
}
